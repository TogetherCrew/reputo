version: '3.9'

networks:
    web:

volumes:
    mongodb_data:
        driver: local
    temporal_elasticsearch_data:
        driver: local
    temporal_postgresql_data:
        driver: local

services:
    mongodb:
        container_name: mongodb
        image: mongo:7.0
        restart: unless-stopped
        networks: [web]
        volumes:
            - mongodb_data:/data/db
        environment:
            - MONGO_INITDB_DATABASE=reputo_preview
        # No auth for preview simplicity - replica set enabled for Change Streams
        command: mongod --bind_ip_all --replSet rs0
        healthcheck:
            test: ['CMD', 'mongosh', '--eval', "try { rs.status() } catch(e) { rs.initiate({_id:'rs0',members:[{_id:0,host:'localhost:27017'}]}) }"]
            interval: 10s
            timeout: 10s
            retries: 5
            start_period: 30s

    traefik:
        image: traefik:v3.4
        container_name: traefik
        ports:
            - '80:80'
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
        networks: [web]
        healthcheck:
            test: ['CMD', 'traefik', 'healthcheck', '--ping']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 10s
        command:
            - --api=true
            - --ping=true
            - --providers.docker=true
            - --providers.docker.exposedByDefault=false
            - --entrypoints.web.address=:80
            - --metrics.prometheus=true
            - --metrics.prometheus.addRoutersLabels=true

    ui:
        container_name: ui
        depends_on:
            - traefik
        build:
            context: ..
            dockerfile: docker/Dockerfile
            target: ui
            args:
                NEXT_PUBLIC_API_URL: http://api.${PULLPREVIEW_PUBLIC_DNS}/api/v1
        restart: unless-stopped
        networks: [web]
        environment:
            - NEXT_PUBLIC_API_URL=http://api.${PULLPREVIEW_PUBLIC_DNS}/api/v1
        labels:
            - traefik.enable=true
            - traefik.http.routers.ui.rule=Host(`${PULLPREVIEW_PUBLIC_DNS}`)
            - traefik.http.routers.ui.entrypoints=web

    api:
        container_name: api
        depends_on:
            mongodb:
                condition: service_healthy
        build:
            context: ..
            dockerfile: docker/Dockerfile
            target: api
        restart: unless-stopped
        networks: [web]
        labels:
            - traefik.enable=true
            - traefik.http.routers.api.rule=Host(`api.${PULLPREVIEW_PUBLIC_DNS}`)
            - traefik.http.routers.api.entrypoints=web
            - traefik.http.routers.api.middlewares=api-cors
            - traefik.http.services.api.loadbalancer.server.port=3000
            - traefik.http.middlewares.api-cors.headers.accessControlAllowMethods=GET,OPTIONS,PUT,POST,DELETE,PATCH
            - traefik.http.middlewares.api-cors.headers.accessControlAllowOriginList=*
            - traefik.http.middlewares.api-cors.headers.accessControlAllowHeaders=Content-Type,Authorization,Accept,Origin,X-Requested-With
            - traefik.http.middlewares.api-cors.headers.accessControlMaxAge=3600
            # - traefik.http.middlewares.api-cors.headers.accessControlAllowCredentials=true
        environment:
            - NODE_ENV=development
            - PORT=3000
            - LOG_LEVEL=info
            - MONGODB_HOST=mongodb
            - MONGODB_PORT=27017
            - MONGODB_DB_NAME=reputo_preview
            - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
            - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
            - AWS_REGION=eu-central-1
            - STORAGE_BUCKET=reputo-pullpreview
            - STORAGE_PRESIGN_PUT_TTL=120
            - STORAGE_PRESIGN_GET_TTL=300
            - STORAGE_MAX_SIZE_BYTES=52428800
            - STORAGE_CONTENT_TYPE_ALLOWLIST=text/csv,text/plain
            - TEMPORAL_ADDRESS=temporal:7233
            - TEMPORAL_NAMESPACE=default
            - TEMPORAL_TASK_QUEUE=workflows
    temporal:
        container_name: temporal
        image: temporalio/auto-setup:1.26.3.0
        restart: unless-stopped
        depends_on:
            - temporal-postgresql
            - temporal-elasticsearch
        ports:
            - '7233:7233'
        networks:
            - web
        environment:
            - DB=postgres12
            - DB_PORT=5432
            - POSTGRES_USER=temporal
            - POSTGRES_PWD=temporal
            - POSTGRES_SEEDS=temporal-postgresql
            - ENABLE_ES=true
            - ES_SEEDS=temporal-elasticsearch
            - ES_VERSION=v7
        healthcheck:
            test:
                [
                    'CMD',
                    'tctl',
                    '--address',
                    'temporal:7233',
                    'workflow',
                    'list',
                ]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 90s

    temporal-ui:
        container_name: temporal-ui
        image: temporalio/ui:2.32.0
        restart: unless-stopped
        depends_on:
            - temporal
        networks:
            - web
        ports:
            - '8088:8080'
        environment:
            - TEMPORAL_ADDRESS=temporal:7233
            - TEMPORAL_CORS_ORIGINS=*

    temporal-elasticsearch:
        container_name: temporal-elasticsearch
        restart: unless-stopped
        image: elasticsearch:7.17.23
        environment:
            - cluster.routing.allocation.disk.threshold_enabled=true
            - cluster.routing.allocation.disk.watermark.low=512mb
            - cluster.routing.allocation.disk.watermark.high=256mb
            - cluster.routing.allocation.disk.watermark.flood_stage=128mb
            - discovery.type=single-node
            - ES_JAVA_OPTS=-Xms256m -Xmx256m
            - xpack.security.enabled=false
        volumes:
            - temporal_elasticsearch_data:/var/lib/elasticsearch/data
        networks:
            - web

    temporal-postgresql:
        container_name: temporal-postgresql
        image: postgres:12.22
        restart: unless-stopped
        networks:
            - web
        volumes:
            - temporal_postgresql_data:/var/lib/postgresql/data
        environment:
            - POSTGRES_USER=temporal
            - POSTGRES_PASSWORD=temporal
            - POSTGRES_DB=temporal

    typescript-worker:
        container_name: typescript-worker
        depends_on:
            temporal:
                condition: service_healthy
        build:
            context: ..
            dockerfile: docker/Dockerfile
            target: typescript-worker
        restart: unless-stopped
        networks: [web]
        environment:
            - NODE_ENV=development
            - LOG_LEVEL=info
            - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
            - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
            - AWS_REGION=eu-central-1
            - STORAGE_BUCKET=reputo-pullpreview
            - STORAGE_PRESIGN_PUT_TTL=120
            - STORAGE_PRESIGN_GET_TTL=300
            - STORAGE_MAX_SIZE_BYTES=52428800
            - STORAGE_CONTENT_TYPE_ALLOWLIST=text/csv,text/plain
            - TEMPORAL_ADDRESS=temporal:7233
            - TEMPORAL_NAMESPACE=default
            - TEMPORAL_TASK_QUEUE=typescript-worker

    workflows:
        container_name: workflows
        depends_on:
            mongodb:
                condition: service_healthy
            temporal:
                condition: service_healthy
        build:
            context: ..
            dockerfile: docker/Dockerfile
            target: workflows
        restart: unless-stopped
        networks: [web]
        environment:
            - TEMPORAL_ADDRESS=temporal:7233
            - TEMPORAL_NAMESPACE=default
            - TEMPORAL_TASK_QUEUE=workflows
            - MONGODB_HOST=mongodb
            - MONGODB_PORT=27017
            - MONGODB_DB_NAME=reputo_preview
