networks:
    preview:

volumes:
    mongodb_data:
        driver: local
    temporal_elasticsearch_data:
        driver: local
    temporal_postgresql_data:
        driver: local

services:
    mongodb:
        container_name: mongodb
        image: mongo:7.0.5
        restart: unless-stopped
        networks: [preview]
        user: '0:0'
        entrypoint: >
            /bin/bash -c "chown 999:999 /etc/mongo/keyfile.txt &&
            chmod 400 /etc/mongo/keyfile.txt &&
            exec docker-entrypoint.sh mongod
            --replSet rs0
            --keyFile /etc/mongo/keyfile.txt
            --bind_ip_all"

        environment:
            - MONGO_INITDB_ROOT_USERNAME=admin
            - MONGO_INITDB_ROOT_PASSWORD=preview_password
            - MONGO_INITDB_DATABASE=reputo_preview

        volumes:
            - ./mongo/init.js:/docker-entrypoint-initdb.d/init.js:ro
            - ./mongo/healthcheck.js:/etc/mongo/healthcheck.js:ro
            - ./mongo/keyfile.txt:/etc/mongo/keyfile.txt
            - mongodb_data:/data/db

        healthcheck:
            test: test $(echo $(mongosh -u $$MONGO_INITDB_ROOT_USERNAME -p $$MONGO_INITDB_ROOT_PASSWORD --quiet /etc/mongo/healthcheck.js)) -eq 1
            interval: 60s
            timeout: 60s
            retries: 5
            start_period: 40s

    traefik:
        image: traefik:v3.5.0
        container_name: traefik
        ports:
            - '80:80'
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
        networks: [preview]
        healthcheck:
            test: ['CMD', 'traefik', 'healthcheck', '--ping']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 10s
        command:
            - --api=true
            - --ping=true
            - --providers.docker=true
            - --providers.docker.exposedByDefault=false
            - --entrypoints.web.address=:80
            - --metrics.prometheus=true
            - --metrics.prometheus.addRoutersLabels=true

    ui:
        container_name: ui
        depends_on:
            - traefik
        build:
            context: ..
            dockerfile: docker/Dockerfile
            target: ui
            args:
                NEXT_PUBLIC_API_URL: http://api.${PULLPREVIEW_PUBLIC_DNS}/api/v1
        restart: unless-stopped
        networks: [preview]
        environment:
            - NEXT_PUBLIC_API_URL=http://api.${PULLPREVIEW_PUBLIC_DNS}/api/v1
            - PORT=8080
        labels:
            - traefik.enable=true
            - traefik.http.routers.ui.rule=Host(`${PULLPREVIEW_PUBLIC_DNS}`)
            - traefik.http.routers.ui.entrypoints=web
            - traefik.http.services.ui.loadbalancer.server.port=8080

    api:
        container_name: api
        depends_on:
            mongodb:
                condition: service_healthy
            temporal:
                condition: service_healthy
        build:
            context: ..
            dockerfile: docker/Dockerfile
            target: api
        restart: unless-stopped
        networks: [preview]
        labels:
            - traefik.enable=true
            - traefik.http.routers.api.rule=Host(`api.${PULLPREVIEW_PUBLIC_DNS}`)
            - traefik.http.routers.api.entrypoints=web
            - traefik.http.routers.api.middlewares=api-cors
            - traefik.http.services.api.loadbalancer.server.port=3000
            - traefik.http.middlewares.api-cors.headers.accessControlAllowMethods=GET,OPTIONS,PUT,POST,DELETE,PATCH
            - traefik.http.middlewares.api-cors.headers.accessControlAllowOriginList=*
            - traefik.http.middlewares.api-cors.headers.accessControlAllowHeaders=Content-Type,Authorization,Accept,Origin,X-Requested-With
            - traefik.http.middlewares.api-cors.headers.accessControlMaxAge=3600
            # - traefik.http.middlewares.api-cors.headers.accessControlAllowCredentials=true
        environment:
            - NODE_ENV=development
            - PORT=3000
            - LOG_LEVEL=info
            - MONGODB_HOST=mongodb
            - MONGODB_PORT=27017
            - MONGODB_DB_NAME=reputo_preview
            - MONGODB_USER=admin
            - MONGODB_PASSWORD=preview_password
            - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
            - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
            - AWS_REGION=eu-central-1
            - STORAGE_BUCKET=reputo-pullpreview
            - STORAGE_PRESIGN_PUT_TTL=120
            - STORAGE_PRESIGN_GET_TTL=300
            - STORAGE_MAX_SIZE_BYTES=52428800
            - STORAGE_CONTENT_TYPE_ALLOWLIST=text/csv,text/plain,application/json
            - TEMPORAL_ADDRESS=temporal:7233
            - TEMPORAL_NAMESPACE=default
            - TEMPORAL_ORCHESTRATOR_TASK_QUEUE=orchestrator-worker
            - TEMPORAL_TASK_QUEUE=orchestrator-worker
            - TEMPORAL_ALGORITHM_TYPESCRIPT_TASK_QUEUE=algorithm-typescript-worker
            - TEMPORAL_ALGORITHM_PYTHON_TASK_QUEUE=algorithm-python-worker
    temporal:
        container_name: temporal
        image: temporalio/auto-setup:1.26.3.0
        restart: unless-stopped
        depends_on:
            - temporal-postgresql
            - temporal-elasticsearch
        ports:
            - '7233:7233'
        networks: [preview]
        environment:
            - DB=postgres12
            - DB_PORT=5432
            - POSTGRES_USER=temporal
            - POSTGRES_PWD=temporal
            - POSTGRES_SEEDS=temporal-postgresql
            - ENABLE_ES=true
            - ES_SEEDS=temporal-elasticsearch
            - ES_VERSION=v7
        healthcheck:
            test:
                [
                    'CMD',
                    'tctl',
                    '--address',
                    'temporal:7233',
                    'workflow',
                    'list',
                ]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 90s

    temporal-ui:
        container_name: temporal-ui
        image: temporalio/ui:2.32.0
        restart: unless-stopped
        depends_on:
            - temporal
        networks: [preview]
        ports:
            - '8088:8080'
        environment:
            - TEMPORAL_ADDRESS=temporal:7233
            - TEMPORAL_CORS_ORIGINS=*

    temporal-elasticsearch:
        container_name: temporal-elasticsearch
        restart: unless-stopped
        image: elasticsearch:7.17.23
        environment:
            - cluster.routing.allocation.disk.threshold_enabled=true
            - cluster.routing.allocation.disk.watermark.low=512mb
            - cluster.routing.allocation.disk.watermark.high=256mb
            - cluster.routing.allocation.disk.watermark.flood_stage=128mb
            - discovery.type=single-node
            - ES_JAVA_OPTS=-Xms256m -Xmx256m
            - xpack.security.enabled=false
        volumes:
            - temporal_elasticsearch_data:/var/lib/elasticsearch/data
        networks: [preview]

    temporal-postgresql:
        container_name: temporal-postgresql
        image: postgres:12.22
        restart: unless-stopped
        networks: [preview]
        volumes:
            - temporal_postgresql_data:/var/lib/postgresql/data
        environment:
            - POSTGRES_USER=temporal
            - POSTGRES_PASSWORD=temporal
            - POSTGRES_DB=temporal

    orchestrator-worker:
        container_name: orchestrator-worker
        depends_on:
            mongodb:
                condition: service_healthy
            temporal:
                condition: service_healthy
        build:
            context: ..
            dockerfile: docker/Dockerfile
            target: workflows
        command: ['pnpm', 'start:orchestrator']
        restart: unless-stopped
        networks: [preview]
        environment:
            - NODE_ENV=development
            - LOG_LEVEL=info
            - TEMPORAL_ADDRESS=temporal:7233
            - TEMPORAL_NAMESPACE=default
            - TEMPORAL_ORCHESTRATOR_TASK_QUEUE=orchestrator-worker
            - TEMPORAL_ALGORITHM_TYPESCRIPT_TASK_QUEUE=algorithm-typescript-worker
            - TEMPORAL_ALGORITHM_PYTHON_TASK_QUEUE=algorithm-python-worker
            - MONGODB_HOST=mongodb
            - MONGODB_PORT=27017
            - MONGODB_DB_NAME=reputo_preview
            - MONGODB_USER=admin
            - MONGODB_PASSWORD=preview_password
            - STORAGE_BUCKET=reputo-pullpreview
            - STORAGE_PRESIGN_PUT_TTL=120
            - STORAGE_PRESIGN_GET_TTL=300
            - STORAGE_MAX_SIZE_BYTES=52428800
            - STORAGE_CONTENT_TYPE_ALLOWLIST=text/csv,text/plain,application/json
            - DEEPFUNDING_API_BASE_URL=https://api.deepfunding.xyz
            - DEEPFUNDING_API_KEY=${DEEPFUNDING_API_KEY}
            - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
            - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
            - AWS_REGION=eu-central-1
    typescript-worker:
        container_name: typescript-worker
        depends_on:
            temporal:
                condition: service_healthy
        build:
            context: ..
            dockerfile: docker/Dockerfile
            target: workflows
        command: ['pnpm', 'start:algorithm-typescript']
        restart: unless-stopped
        networks: [preview]
        environment:
            - NODE_ENV=development
            - LOG_LEVEL=info
            - TEMPORAL_ADDRESS=temporal:7233
            - TEMPORAL_NAMESPACE=default
            - TEMPORAL_ORCHESTRATOR_TASK_QUEUE=orchestrator-worker
            - TEMPORAL_ALGORITHM_TYPESCRIPT_TASK_QUEUE=algorithm-typescript-worker
            - TEMPORAL_ALGORITHM_PYTHON_TASK_QUEUE=algorithm-python-worker
            - MONGODB_HOST=mongodb
            - MONGODB_PORT=27017
            - MONGODB_DB_NAME=reputo_preview
            - MONGODB_USER=admin
            - MONGODB_PASSWORD=preview_password
            - STORAGE_BUCKET=reputo-pullpreview
            - STORAGE_PRESIGN_PUT_TTL=120
            - STORAGE_PRESIGN_GET_TTL=300
            - STORAGE_MAX_SIZE_BYTES=52428800
            - STORAGE_CONTENT_TYPE_ALLOWLIST=text/csv,text/plain,application/json
            - DEEPFUNDING_API_BASE_URL=https://api.deepfunding.xyz
            - DEEPFUNDING_API_KEY=${DEEPFUNDING_API_KEY}
            - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
            - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
            - AWS_REGION=eu-central-1
